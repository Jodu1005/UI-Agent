# 任务列表：支持根据子图片识别在完整图片中的位置并点击

## 任务概述

本变更将添加基于 OpenCV 模板匹配的 UI 元素定位能力，允许用户提供子图片作为模板来定位和点击屏幕元素。

---

## 阶段 1：基础设施

### 任务 1.1：添加依赖

**文件**：`pyproject.toml`

**步骤**：
1. 在 dependencies 中添加 `opencv-python>=4.8.0`
2. 可选：添加 `opencv-python-headless` 用于无 GUI 环境

**验证**：
- 依赖安装成功
- `import cv2` 不报错

**依赖**：无

---

### 任务 1.2：创建模板存储目录结构

**文件**：
- `config/templates/`（新目录）
- `config/templates/.gitkeep`（占位文件）

**步骤**：
1. 创建模板图片存储目录
2. 添加 README 说明模板图片的命名规范

**验证**：
- 目录创建成功
- 用户知道在哪里存放模板图片

**依赖**：无

---

## 阶段 2：核心匹配器实现

### 任务 2.1：创建 TemplateMatcher 类

**文件**：`src/locator/template_matcher.py`（新建）

**步骤**：
1. 实现 `__init__` 方法，初始化模板目录
2. 实现 `load_template` 方法，加载模板图片
3. 实现 `match` 方法，执行单尺度模板匹配
4. 实现模板缓存机制

**验证**：
- 能成功加载模板图片
- 匹配返回正确的坐标
- 单元测试通过

**依赖**：任务 1.1, 任务 1.2

---

### 任务 2.2：实现多尺度匹配

**文件**：`src/locator/template_matcher.py`

**步骤**：
1. 实现 `match_all_sizes` 方法
2. 支持配置缩放比例列表
3. 实现多尺度结果的合并和排序

**验证**：
- 能匹配到缩放后的模板
- 单元测试覆盖不同缩放比例

**依赖**：任务 2.1

---

### 任务 2.3：添加匹配结果过滤

**文件**：`src/locator/template_matcher.py`

**步骤**：
1. 实现置信度阈值过滤
2. 实现非极大值抑制（NMS）避免重叠匹配
3. 支持返回最佳 N 个匹配结果

**验证**：
- 低置信度结果被正确过滤
- 重叠匹配被合并

**依赖**：任务 2.1

---

## 阶段 3：配置集成

### 任务 3.1：扩展配置系统

**文件**：
- `src/config/schema.py`
- `src/config/config_manager.py`
- `config/main.yaml`

**步骤**：
1. 添加 `TemplatesConfig` 数据类
2. 在 `MainConfig` 中添加 `templates` 字段
3. 更新配置解析逻辑
4. 在主配置文件中添加模板配置示例

**验证**：
- 配置能够正确加载
- 默认值合理

**依赖**：任务 1.2

---

### 任务 3.2：创建操作配置示例

**文件**：`config/operations/pycharm.yaml`

**步骤**：
1. 添加 `template_match` 意图类型的操作示例
2. 配置模板名称和阈值参数
3. 定义操作序列

**验证**：
- 操作配置能被正确加载
- 格式符合现有规范

**依赖**：任务 3.1

---

## 阶段 4：控制器集成

### 任务 4.1：更新 IDEController

**文件**：`src/controller/ide_controller.py`

**步骤**：
1. 初始化 `TemplateMatcher` 实例
2. 在 `_execute_operation` 中添加模板匹配路由
3. 实现定位器优先级逻辑：模板 > 视觉 > OCR

**验证**：
- 控制器正常初始化
- 模板匹配路由正确工作

**依赖**：任务 2.1, 任务 3.1

---

### 任务 4.2：扩展命令解析器

**文件**：`src/parser/command_parser.py`

**步骤**：
1. 添加 `template_name` 参数提取
2. 支持命令中指定模板（如："点击运行按钮[run_button.png]"）
3. 更新 `ParsedCommand` 数据模型

**验证**：
- 能正确解析模板名称
- 单元测试通过

**依赖**：无

---

## 阶段 5：测试

### 任务 5.1：模板匹配单元测试

**文件**：`tests/unit/test_template_matcher.py`（新建）

**步骤**：
1. 测试模板加载
2. 测试单尺度匹配准确性
3. 测试多尺度匹配
4. 测试阈值过滤
5. 测试边界情况（模板不存在、无匹配等）

**验证**：
- 所有单元测试通过
- 代码覆盖率 > 80%

**依赖**：任务 2.3

---

### 任务 5.2：集成测试

**文件**：`tests/integration/test_template_matching.py`（新建）

**步骤**：
1. 准备测试用的模板和截图
2. 测试从命令解析到执行的全流程
3. 测试不同场景（不同分辨率、不同 UI）

**验证**：
- 集成测试通过
- 手动验证成功

**依赖**：任务 4.1, 任务 4.2

---

## 阶段 6：文档

### 任务 6.1：更新使用文档

**文件**：`docs/USAGE.md`

**步骤**：
1. 添加模板匹配使用说明
2. 说明如何准备模板图片
3. 提供使用示例

**验证**：
- 文档清晰易懂
- 包含完整的示例

**依赖**：任务 5.2

---

### 任务 6.2：添加模板图片说明

**文件**：`config/templates/README.md`（新建）

**步骤**：
1. 说明模板图片的命名规范
2. 说明如何截取合适的模板
3. 提供最佳实践建议

**验证**：
- 用户能根据说明准备模板

**依赖**：任务 1.2

---

## 任务依赖关系

```
阶段 1: 基础设施
├── 任务 1.1: 添加依赖 ──────┐
└── 任务 1.2: 创建目录 ──────┤
                            │
阶段 2: 核心匹配器           │
├── 任务 2.1: 创建匹配器 ────┤
├── 任务 2.2: 多尺度匹配 ─────┤
└── 任务 2.3: 结果过滤 ───────┤
                            │
阶段 3: 配置集成             │
├── 任务 3.1: 扩展配置 ──────┤
└── 任务 3.2: 操作配置 ───────┤
                            │
阶段 4: 控制器集成           │
├── 任务 4.1: 更新控制器 ─────┤
└── 任务 4.2: 扩展解析器 ─────┤
                            │
阶段 5: 测试                 │
├── 任务 5.1: 单元测试 ───────┤
└── 任务 5.2: 集成测试 ───────┤
                            │
阶段 6: 文档                 │
├── 任务 6.1: 使用文档 ───────┘
└── 任务 6.2: 模板说明
```

## 可并行任务

以下任务可以并行执行：
- 任务 2.2 和任务 2.3（在任务 2.1 完成后）
- 任务 3.2 和任务 4.2（在各自的依赖完成后）
- 任务 6.1 和任务 6.2（可以随时进行）

## 验收标准

- [x] OpenCV 依赖正确安装
- [x] 模板匹配功能正常工作
- [x] 能匹配缩放后的模板
- [x] 单元测试覆盖率 > 80%
- [ ] 集成测试通过
- [x] 文档完整清晰
