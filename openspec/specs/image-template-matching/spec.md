# image-template-matching Specification

## Purpose
TBD - created by archiving change add-image-template-matching. Update Purpose after archive.
## 需求
### 需求：模板匹配定位能力

系统**必须**支持使用图片模板在屏幕截图中查找匹配的 UI 元素位置。

#### 场景：单模板精确匹配

**给定**：用户提供一个模板图片 `run_button.png`
**并且**：模板图片在当前屏幕截图中存在且大小一致

**当**：执行命令"点击运行按钮"

**那么**：
- 系统**必须**在截图中找到与模板匹配的位置
- 系统**必须**返回匹配区域的边界框坐标
- 匹配置信度**应**大于配置的阈值

#### 场景：多尺度模板匹配

**给定**：用户提供一个模板图片
**并且**：屏幕中的目标元素可能比模板大或小 20%

**当**：执行模板匹配

**那么**：
- 系统**应该**尝试多个缩放比例（如 0.8, 0.9, 1.0, 1.1, 1.2）
- 系统**应该**返回置信度最高的匹配结果
- 如果最高置信度低于阈值，系统**应该**返回空列表

#### 场景：多个匹配结果

**给定**：模板图片在截图中出现多次（如多个相同按钮）

**当**：执行模板匹配

**然后**：
- 系统**应该**返回所有超过阈值的匹配结果
- 系统**应该**按置信度从高到低排序
- 系统可配置返回最大匹配数量

#### 场景：模板未找到

**给定**：模板图片在截图中不存在

**当**：执行模板匹配

**然后**：
- 系统**必须**返回空列表
- 系统**应该**记录警告日志

---

### 需求：模板图片管理

系统**必须**支持模板图片的存储、加载和缓存。

#### 场景：加载已存在的模板

**给定**：模板图片存在于配置的模板目录中
**并且**：文件名为 `save_icon.png`

**当**：系统需要使用该模板

**然后**：
- 系统**必须**从 `config/templates/` 目录加载图片
- 加载后的模板**应该**被缓存以备后续使用

#### 场景：模板文件不存在

**给定**：命令引用了不存在的模板文件

**当**：系统尝试加载模板

**然后**：
- 系统**必须**抛出或记录适当的错误
- 系统**应该**提供清晰的错误信息（包含文件名）
- 系统不应**崩溃**

---

### 需求：模板匹配配置

系统**必须**支持通过配置文件控制模板匹配行为。

#### 场景：配置模板目录

**给定**：`config/main.yaml` 包含以下配置：

```yaml
templates:
  dir: config/templates/
  cache_enabled: true
  default_threshold: 0.8
```

**当**：系统启动

**然后**：
- 系统**必须**从指定目录加载模板
- 模板缓存**必须**被启用
- 默认匹配置信度阈值**应**为 0.8

#### 场景：配置多尺度匹配

**给定**：配置包含：

```yaml
templates:
  scales: [0.8, 0.9, 1.0, 1.1, 1.2]
```

**当**：执行模板匹配

**然后**：
- 系统**应该**尝试配置的所有缩放比例
- 系统**应该**返回最佳匹配

#### 场景：单个操作的阈值配置

**给定**：操作配置包含：

```yaml
- name: click_run_button
  template: run_button.png
  threshold: 0.85
```

**当**：执行此操作

**然后**：
- 系统**必须**使用操作特定的阈值 0.85
- 而非全局默认阈值

---

### 需求：模板匹配操作

系统**必须**支持基于模板匹配的自动化操作。

#### 场景：基于模板点击

**给定**：操作配置为：

```yaml
- name: click_run_button
  aliases: [点击运行]
  intent: template_match
  template: run_button.png
  threshold: 0.8

  actions:
    - type: click
      target: "0"
```

**当**：用户执行"点击运行"命令

**然后**：
- 系统**必须**使用模板匹配定位按钮
- 系统**必须**点击匹配到的位置
- 如果匹配失败，系统**应该**返回错误

#### 场景：模板匹配命令解析

**给定**：用户输入命令"点击运行按钮[run_button.png]"

**当**：系统解析命令

**然后**：
- 系统**必须**提取操作类型为"点击"
- 系统**必须**提取模板名称为"run_button.png"
- 系统**应该**使用模板匹配进行定位

---

### 需求：定位器优先级路由

当存在多种定位方式时，系统**必须**按照合理的优先级选择定位器。

#### 场景：模板匹配优先

**给定**：命令指定了模板图片
**并且**：视觉识别和 OCR 都可用

**当**：执行定位

**然后**：
- 系统**必须**优先使用模板匹配
- 不调用视觉识别 API
- 不使用 OCR

#### 场景：模板匹配回退

**给定**：命令指定了模板图片
**并且**：模板匹配未找到结果（置信度低于阈值）

**当**：允许回退时配置为 true

**然后**：
- 系统**应该**尝试使用视觉识别作为回退
- 如果视觉识别禁用，系统**应该**尝试 OCR

---

