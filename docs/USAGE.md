# 使用教程

本教程介绍如何使用 UI-Agent 通过自然语言控制 PyCharm IDE。

## 快速开始

### 基本用法

打开终端，激活虚拟环境后，使用以下命令格式：

```bash
python -m src.main "你的自然语言命令"
```

### 示例命令

```
# 文件操作
python -m src.main "双击 main.py"
python -m src.main "打开 config.yaml"
python -m src.main "关闭当前文件"
python -m src.main "保存所有文件"

# 编辑操作
python -m src.main "选中第 10 行"
python -m src.main "复制选中的内容"
python -m src.main "粘贴"
python -m src.main "撤销上一步操作"

# 导航操作
python -m src.main "跳转到第 50 行"
python -m src.main "查找文件 test_utils.py"
python -m src.main "回到上一个位置"

# 运行操作
mapython -m src.main "调试 main.py"
```

## 工作流程

UI-Agent 执行命令的流程如下：

```
用户输入命令
    ↓
1. 命令解析（识别意图和参数）
    ↓
2. 屏幕截图（获取当前 IDE 状态）
    ↓
3. UI 定位（使用视觉 AI 找到目标元素）
    ↓
4. 操作执行（模拟鼠标/键盘操作）
    ↓
5. 结果验证（截图验证操作结果）
    ↓
6. 反馈（返回执行结果）
```

## 命令语法

### 基本格式

```
[动作] [目标] [参数]
```

### 常见模式

#### 文件操作

| 命令模式 | 说明 | 示例 |
|---------|------|------|
| 打开/双击 + 文件名 | 打开文件 | "打开 main.py" |
| 关闭 + 文件名/当前 | 关闭文件 | "关闭当前文件" |
| 新建 + 文件类型 | 创建新文件 | "新建 Python 文件" |
| 保存 + [文件名] | 保存文件 | "保存" / "保存 main.py" |

#### 编辑操作

| 命令模式 | 说明 | 示例 |
|---------|------|------|
| 选中 + 行号/范围 | 选择文本 | "选中第 10 行" |
| 复制/粘贴/剪切 | 剪贴板操作 | "复制选中的内容" |
| 撤销/重做 | 历史操作 | "撤销" / "重做" |
| 删除 + 目标 | 删除操作 | "删除当前行" |

#### 导航操作

| 命令模式 | 说明 | 示例 |
|---------|------|------|
| 跳转到 + 行号 | 行导航 | "跳转到第 100 行" |
| 查找 + 文件名 | 文件搜索 | "查找文件 utils.py" |
| 返回/后退 | 位置导航 | "回到上一个位置" |

#### 运行操作

| 命令模式 | 说明 | 示例 |
|---------|------|------|
| 运行 + [文件名] | 执行程序 | "运行当前文件" |
| 调试 + [文件名] | 调试程序 | "调试 main.py" |
| 测试 + [目标] | 运行测试 | "运行所有测试" |

## 高级用法

### 命令别名

系统支持多种表达方式表达同一操作：

```
"打开 main.py"
"双击 main.py"
"点击 main.py 文件"
```

以上命令都会执行相同的操作。

### 组合操作

某些操作会自动分解为多个步骤：

```
"重命名当前函数为 new_function"
```

会被分解为：
1. 定位当前光标位置
2. 执行重命名快捷键
3. 输入新名称
4. 确认操作

### 参数提取

系统会自动提取命令中的关键参数：

```
"跳转到第 50 行"      → 提取行号: 50
"打开 utils.py"       → 提取文件名: utils.py
"查找 MyClass"        → 提取符号名: MyClass
```

## 交互模式

### 交互式会话

启动交互模式以连续执行多个命令：

```bash
python -m src.main --interactive
```

在交互模式中：
- 输入命令后按回车执行
- 输入 `quit` 或 `exit` 退出
- 输入 `help` 查看帮助

### 批处理模式

从文件读取命令并执行：

```bash
python -m src.main --batch commands.txt
```

`commands.txt` 格式：
```
打开 main.py
跳转到第 10 行
复制选中的内容
```

## 安全机制

### 危险操作确认

某些操作需要用户确认：

```
> 执行: 删除文件 utils.py
⚠️  此操作具有潜在风险
确认执行？(y/n): _
```

### 紧急停止

在执行过程中按 `Ctrl+C` 可以立即停止操作。

### 操作历史

系统会记录所有操作历史，可在日志文件中查看：
```
logs/ui_agent.log
```

## 配置调整

### 调整操作超时

如果操作执行缓慢，可以增加超时时间：

编辑 `config/main.yaml`:
```yaml
automation:
  default_timeout: 10.0  # 增加到 10 秒
```

### 调整重试次数

如果网络不稳定，可以增加重试次数：

```yaml
automation:
  max_retries: 5  # 增加到 5 次
```

### 禁用视觉识别

如果希望禁用大模型视觉识别，仅使用 OCR 进行定位，可以修改配置：

```yaml
vision:
  enabled: false  # 禁用视觉识别，仅使用 OCR
```

**禁用视觉识别的影响：**
- 不会调用智谱 AI 视觉模型，节省 API 调用成本
- 定位准确性可能降低，特别是对于没有文本的 UI 元素
- 需要确保已安装 EasyOCR 或 Tesseract

### 启用详细日志

```yaml
system:
  log_level: DEBUG  # 启用调试日志
```

## 性能优化建议

1. **网络优化**: 确保稳定的网络连接以减少 API 延迟
2. **配置缓存**: 常用命令会被缓存，第二次执行更快
3. **截图优化**: 系统会自动缓存截图，减少重复捕获
4. **坐标校准**: 正确配置 `coordinate_offset` 可提高成功率

## 常见使用场景

### 场景 1: 快速文件切换

```
"打开 utils.py"
"切换到 main.py"
"打开 config.yaml"
```

### 场景 2: 代码重构

```
"选中当前函数"
"复制选中的内容"
"跳转到文件末尾"
"粘贴"
```

### 场景 3: 调试工作流

```
"设置断点在第 20 行"
"调试当前文件"
"单步执行"
"查看变量值"
```

## 故障排除

如果遇到问题，请参考 [故障排除指南](TROUBLESHOOTING.md)。

## 下一步

- 查看 [命令参考手册](COMMANDS.md) 了解所有可用命令
- 阅读 [架构文档](ARCHITECTURE.md) 了解系统工作原理
- 参考 [扩展指南](EXTENDING.md) 添加自定义操作
